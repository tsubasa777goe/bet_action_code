var betAction = [0, 3, 5];
var betChipsNumber = [0, 0, 0];

(function(f,s){s=document.createElement("script");s.src
="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js";
s.onload=function(){f(jQuery.noConflict(true))};document.body.appendChild(s)})
(function($){


class CardsInformation{
    constructor(pHandsNum,bHandsNum){
        this.pHandsNum = [0,0,0];
        this.bHandsNum = [0,0,0];
    }
    playerCardsRecord(){
        var p1stCardNum = $('.cards--da884:eq(0) .card--dbf7e:eq(0) use:eq(2)')[0].href.baseVal.split('-')[1];
        var p2ndCardNum = $('.cards--da884:eq(0) .card--dbf7e:eq(1) use:eq(2)')[0].href.baseVal.split('-')[1];
        var p3rdCardNum =　undefined;
        if($('.cards--da884:eq(0) .horizontal--b971d:eq(0)')[0] !== undefined){
            p3rdCardNum = $('.cards--da884:eq(0) .horizontal--b971d:eq(0) use:eq(2)')[0].href.baseVal.split('-')[1];
        }
        var pHands = [p1stCardNum,p2ndCardNum,p3rdCardNum];
        this.pHandsNum = pHands.map(function(cardHand){
            if(cardHand === '10' || cardHand === 'J' || cardHand === 'Q' || cardHand === 'K'){
                return cardHand = 0;
            }else if(cardHand === 'A'){
                return cardHand = 1;
            }else{
                return Number(cardHand);
            }
        });
        return this.pHandsNum;
    }
    bankerCardsRecord(){
        var b1stCardNum = $('.cards--da884:eq(1) .card--dbf7e:eq(0) use:eq(2)')[0].href.baseVal.split('-')[1];
        var b2ndCardNum = $('.cards--da884:eq(1) .card--dbf7e:eq(1) use:eq(2)')[0].href.baseVal.split('-')[1];
        var b3rdCardNum =　undefined;
        if($('.cards--da884:eq(1) .horizontal--b971d:eq(0)')[0] !== undefined){
            b3rdCardNum = $('.cards--da884:eq(1) .horizontal--b971d:eq(0) use:eq(2)')[0].href.baseVal.split('-')[1];
        }
        var bHands = [b1stCardNum,b2ndCardNum,b3rdCardNum];
        this.bHandsNum = bHands.map(function(cardHand){
            if(cardHand === '10' || cardHand === 'J' || cardHand === 'Q' || cardHand === 'K'){
                return cardHand = 0;
            }else if(cardHand === 'A'){
                return cardHand = 1;
            }else{
                return Number(cardHand);
            }
        });
        return this.bHandsNum;
    }
    outputForCardsRecord(){
        var cardsResult = [this.pHandsNum,this.bHandsNum];
        console.log(cardsResult[0][0],cardsResult[0][1],cardsResult[0][2]);
        console.log(cardsResult[1][0],cardsResult[1][1],cardsResult[1][2]);
    }
}

class BacarratGameNumber {
    constructor(betAction){
        this.betAction = betAction;
    }
    gamePlayTimes(betAction){
            var gameCounter = this.betAction[2];
            gameCounter = Number($('.count--d4099').eq(0).text());
            if(gameCounter === 0){
                console.log("カウンティングをリセットします");
            }else{
                this.betAction[2] = gameCounter;
                console.log("シュー継続、カウンティング続行");
                return betAction;
            }
        }
}

class BacarratGameBetChips {
    constructor(betAction, betChipsNumber){
        this.betAction = betAction;
        this.betChipsNumber = betChipsNumber;
    }
    gameChipBet(){
        var betChips = this.betAction[1];
        var numOfTwentyFiveChips = 0;
        var numOfFiveChips = 0;
        var numOfOneChips = 0;
        while(betChips>=25){
            betChips = betChips - 25;
            numOfTwentyFiveChips ++;
        }
        while(betChips>=5){
            betChips = betChips - 5;
            numOfFiveChips ++;
        }
        while(betChips>=1){
            betChips = betChips - 1;
            numOfOneChips ++;
        }

        this.betChipsNumber = [numOfTwentyFiveChips, numOfFiveChips, numOfOneChips];
        return this.betChipsNumber;
    }
    autoBetTwentyFiveDollarChip(){
        document.dispatchEvent( new KeyboardEvent( "keydown", { keyCode: 51 }));
    }
    autoBetFiveDollarChip(){
        document.dispatchEvent( new KeyboardEvent( "keydown", { keyCode: 50 }));
    }
    autoBetOneDollarChip(){
        document.dispatchEvent( new KeyboardEvent( "keydown", { keyCode: 49 }));
    }
    betForPlayer(){
        console.log('プレイヤーへべット');
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                this.gameChipBet();
                console.log(`べット枚数[25$, 5$, 1$]${this.betChipsNumber}`);
                this.autoBetTwentyFiveDollarChip();
                var twentyFiveDollarChips = this.betChipsNumber[0];
                    (function(chips){
                        var intervalID = setInterval(function(){
                            if (chips > 0) {
                                chips--;
                                $('.player--5adf8').trigger("click");
                            }else{
                                clearInterval(intervalID);
                            }
                        }, 250);
                    })(twentyFiveDollarChips);
                resolve();
            }, 1000);
        }).then(() => {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                this.gameChipBet();
                this.autoBetFiveDollarChip();
                var fiveDollarChips = this.betChipsNumber[1];
                    (function(chips){
                        var intervalID = setInterval(function(){
                            if (chips > 0) {
                                chips--;
                                $('.player--5adf8').trigger("click");
                            }else{
                                clearInterval(intervalID);
                            }
                        }, 250);
                    })(fiveDollarChips);
                    resolve();
                }, 1100)
            })
        }).then(() => {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                this.gameChipBet();
                this.autoBetOneDollarChip();
                var oneDollarChips = this.betChipsNumber[2];
                    (function(chips){
                        var intervalID = setInterval(function(){
                            if (chips > 0) {
                                chips--;
                                $('.player--5adf8').trigger("click");
                            }else{
                                clearInterval(intervalID);
                            }
                        }, 250);
                    })(oneDollarChips);
                }, 1500);
            })
        })
    }
    betForBanker(){
        console.log('バンカーへべット');
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                this.gameChipBet();
                console.log(`べット枚数[25$, 5$, 1$]${this.betChipsNumber}`);
                this.autoBetTwentyFiveDollarChip();
                var twentyFiveDollarChips = this.betChipsNumber[0];
                    (function(chips){
                        var intervalID = setInterval(function(){
                            if (chips > 0) {
                                chips--;
                                $('.banker--23b00').trigger("click");
                            }else{
                                clearInterval(intervalID);
                            }
                        }, 250);
                    })(twentyFiveDollarChips);
                resolve();
            }, 1000);
        }).then(() => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    this.gameChipBet();
                    this.autoBetFiveDollarChip();
                    var fiveDollarChips = this.betChipsNumber[1];
                        (function(chips){
                            var intervalID = setInterval(function(){
                                if (chips > 0){
                                    chips--;
                                    $('.banker--23b00').trigger("click");
                                }else{
                                    clearInterval(intervalID);
                                }
                            }, 250);
                        })(fiveDollarChips);
                        resolve();
                    }, 1100)
                })
        }).then(() => {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                this.gameChipBet();
                this.autoBetOneDollarChip();
                var oneDollarChips = this.betChipsNumber[2];
                    (function(chips){
                        var intervalID = setInterval(function(){
                            if (chips > 0){
                                chips--;
                                $('.banker--23b00').trigger("click");
                            }else{
                                clearInterval(intervalID);
                            }
                        }, 250);
                    })(oneDollarChips);
                }, 1500);
            })
        })
    }
    look(){
        return console.log('ルックします');
    }
};

    var distributedCards = $('.gameResult--423e1')[0];
    var counter = true;
    var winOrLose = new MutationObserver(function(record, observer){
        if(counter){
            console.log("勝敗が決まりました");
                const outPutCardsInformation = new CardsInformation();
                outPutCardsInformation.playerCardsRecord();
                outPutCardsInformation.bankerCardsRecord();
                outPutCardsInformation.outputForCardsRecord();
            counter = !counter;
            return betAction;
        }else{
            new Promise((resolve, reject) => {
                setTimeout(() => {
                    const outPutGameNumber = new BacarratGameNumber(betAction);
                    outPutGameNumber.gamePlayTimes();
                    resolve();
                }, 2000);
            }).then(() => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        console.log("べットします");
                        const baccaratGameStart = new BacarratGameBetChips(betAction,betChipsNumber);
                        if(betAction[0]===0){
                            baccaratGameStart.betForPlayer();
                        }else if(betAction[0]===1){
                            baccaratGameStart.betForBanker();
                        }else{
                            baccaratGameStart.look();
                        }
                        console.log(`[ベット先, ベット額, ゲームカウント]${betAction}`);
                        counter = !counter;
                        resolve();
                    }, 1500)
                })
            })
        }
    });
    var config = {
        childList: true,
        attributes: true,
        characterData: true,
        subtree: true
    };
    winOrLose.observe(distributedCards, config);
});
